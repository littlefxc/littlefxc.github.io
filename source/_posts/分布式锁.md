---
title: 分布式锁
date: 2021-04-29 12:24:28
categories: 分布式系统
tags:
- 分布式锁
---

[TOC]

# 如何使用锁解决超卖问题？

<!-- more -->

![image-20210429123322683](https://raw.githubusercontent.com/littlefxc/littlefxc.github.io/images/images/QQ20210429-123340@2x.png)

![image-20210429123825952](https://raw.githubusercontent.com/littlefxc/littlefxc.github.io/images/images/image-20210429123825952.png)

![image-20210429123948747](https://raw.githubusercontent.com/littlefxc/littlefxc.github.io/images/images/QQ20210429-123959@2x-20210429124034459.png)

![](https://raw.githubusercontent.com/littlefxc/littlefxc.github.io/images/images/QQ20210429-124118@2x.png)

![image-20210429124223611](https://raw.githubusercontent.com/littlefxc/littlefxc.github.io/images/images/超卖现象解决_update.png)

 ![image-20210506230736162](https://raw.githubusercontent.com/littlefxc/littlefxc.github.io/images/images/QQ20210506-230803@2x.png)

![](https://raw.githubusercontent.com/littlefxc/littlefxc.github.io/images/images/QQ20210506-230955@2x.png)

![](https://raw.githubusercontent.com/littlefxc/littlefxc.github.io/images/images/QQ20210506-231732@2x.png)

![](https://raw.githubusercontent.com/littlefxc/littlefxc.github.io/images/images/QQ20210506-231848@2x.png)

![image-20210507214519527](https://raw.githubusercontent.com/littlefxc/littlefxc.github.io/images/images/QQ20210507-214536@2x.png)

示例如下所示：

```java
@Service
@Slf4j
public class OrderService {

    @Resource
    private OrderMapper orderMapper;
    @Resource
    private OrderItemMapper orderItemMapper;
    @Resource
    private ProductMapper productMapper;
    //购买商品id
    private int purchaseProductId = 100100;
    //购买商品数量
    private int purchaseProductNum = 1;
    @Autowired
    private PlatformTransactionManager platformTransactionManager;
    @Autowired
    private TransactionDefinition transactionDefinition;

    private Lock lock = new ReentrantLock();


//    @Transactional(rollbackFor = Exception.class)
    public Integer createOrder() throws Exception{
        Product product = null;

        lock.lock();
        try {
            TransactionStatus transaction1 = platformTransactionManager.getTransaction(transactionDefinition);
            product = productMapper.selectByPrimaryKey(purchaseProductId);
            if (product==null){
                platformTransactionManager.rollback(transaction1);
                throw new Exception("购买商品："+purchaseProductId+"不存在");
            }

            //商品当前库存
            Integer currentCount = product.getCount();
            System.out.println(Thread.currentThread().getName()+"库存数："+currentCount);
            //校验库存
            if (purchaseProductNum > currentCount){
                platformTransactionManager.rollback(transaction1);
                throw
                        new Exception("商品"+purchaseProductId+"仅剩"+currentCount+"件，无法购买");
            }

            productMapper.updateProductCount(purchaseProductNum,"xxx",new Date(),product.getId());
            platformTransactionManager.commit(transaction1);
        }finally {
            lock.unlock();
        }

        TransactionStatus transaction = platformTransactionManager.getTransaction(transactionDefinition);
        Order order = new Order();
        order.setOrderAmount(product.getPrice().multiply(new BigDecimal(purchaseProductNum)));
        order.setOrderStatus(1);//待处理
        order.setReceiverName("xxx");
        order.setReceiverMobile("13311112222");
        order.setCreateTime(new Date());
        order.setCreateUser("xxx");
        order.setUpdateTime(new Date());
        order.setUpdateUser("xxx");
        orderMapper.insertSelective(order);

        OrderItem orderItem = new OrderItem();
        orderItem.setOrderId(order.getId());
        orderItem.setProductId(product.getId());
        orderItem.setPurchasePrice(product.getPrice());
        orderItem.setPurchaseNum(purchaseProductNum);
        orderItem.setCreateUser("xxx");
        orderItem.setCreateTime(new Date());
        orderItem.setUpdateTime(new Date());
        orderItem.setUpdateUser("xxx");
        orderItemMapper.insertSelective(orderItem);
        platformTransactionManager.commit(transaction);
        return order.getId();
    }
```

![](https://raw.githubusercontent.com/littlefxc/littlefxc.github.io/images/images/QQ20210507-221236@2x.png)

![QQ20210507-223258@2x](https://raw.githubusercontent.com/littlefxc/littlefxc.github.io/images/images/基于数据库的分布式锁.png)

